<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discover Servers - G-Chat</title>
    <link rel="stylesheet" href="../shared/games-styles.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        .discover-container {
            min-height: 100vh;
            background: var(--bg-primary);
            padding: 2rem;
        }

        .discover-header {
            max-width: 1200px;
            margin: 0 auto 2rem;
            color: var(--text-primary);
        }

        .server-grid {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .server-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .server-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .server-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .server-icon img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .server-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .server-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .server-members {
            color: var(--text-muted);
            font-size: 0.75rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .join-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }

        .join-btn:hover {
            background: #4752c4;
        }

        .back-btn {
            display: inline-block;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="discover-container">
        <div class="discover-header">
            <a href="index.html" class="back-btn">‚Üê Back to G-Chat</a>
            <h1>Discover Servers</h1>
            <p style="color: var(--text-secondary)">Find and join featured community servers</p>
        </div>

        <div id="server-grid" class="server-grid">
            <!-- Servers will be loaded here -->
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA6R63QS_Q5gmFI5GObnTsjfDegFSC6wVA",
            authDomain: "guythatlives-math.firebaseapp.com",
            projectId: "guythatlives-math",
            storageBucket: "guythatlives-math.firebasestorage.app",
            messagingSenderId: "668609251422",
            appId: "1:668609251422:web:b1013698b061b0423c0ccf"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.firestore();

        // Load featured servers
        async function loadFeaturedServers() {
            try {
                const snapshot = await db.collection('gchat')
                    .doc('servers')
                    .collection('list')
                    .where('featured', '==', true)
                    .get();

                const grid = document.getElementById('server-grid');

                if (snapshot.empty) {
                    grid.innerHTML = '<p style="color: var(--text-secondary); text-align: center; grid-column: 1 / -1;">No featured servers yet. Check back later!</p>';
                    return;
                }

                grid.innerHTML = '';

                snapshot.forEach(doc => {
                    const server = { id: doc.id, ...doc.data() };
                    const card = createServerCard(server);
                    grid.appendChild(card);
                });

            } catch (error) {
                console.error('Error loading servers:', error);
                document.getElementById('server-grid').innerHTML =
                    '<p style="color: var(--danger-color); text-align: center; grid-column: 1 / -1;">Failed to load servers</p>';
            }
        }

        function createServerCard(server) {
            const card = document.createElement('div');
            card.className = 'server-card';

            const iconHtml = server.iconUrl
                ? `<img src="${server.iconUrl}" alt="${server.name}">`
                : server.name.charAt(0).toUpperCase();

            const memberCount = server.members?.length || 0;

            card.innerHTML = `
                <div class="server-icon">${iconHtml}</div>
                <div class="server-name">${escapeHtml(server.name)}</div>
                <div class="server-description">${escapeHtml(server.description || 'No description')}</div>
                <div class="server-members">${memberCount} ${memberCount === 1 ? 'member' : 'members'}</div>
                <button class="join-btn" onclick="joinServer('${server.id}')">Join Server</button>
            `;

            return card;
        }

        async function joinServer(serverId) {
            // Check if user is logged in
            const session = localStorage.getItem('gchat_session');

            if (!session) {
                alert('Please login to join servers');
                window.location.href = 'index.html';
                return;
            }

            const { userId } = JSON.parse(session);

            try {
                // Add user to server members
                await db.collection('gchat')
                    .doc('servers')
                    .collection('list')
                    .doc(serverId)
                    .update({
                        members: firebase.firestore.FieldValue.arrayUnion(userId)
                    });

                alert('Joined server! Redirecting...');
                window.location.href = 'index.html';

            } catch (error) {
                console.error('Error joining server:', error);
                alert('Failed to join server');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load on page load
        loadFeaturedServers();
    </script>
</body>
</html>
